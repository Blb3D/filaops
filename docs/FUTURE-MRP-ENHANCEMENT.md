# Future Enhancement: Full MRP with Planned Orders

## Overview

This document describes a future enhancement to implement full Material Requirements Planning (MRP) with planned orders, similar to systems like Infor Visual and MRPeasy.

## Current State (v1.x)

The current implementation uses a **direct order creation** approach:

1. Sales Order created
2. User views `/required-orders` to see MRP cascade
3. User manually creates WOs for sub-assemblies
4. User manually creates POs for raw materials
5. Orders are created immediately (no planning step)

**Limitations:**
- No demand consolidation across multiple SOs
- No planning horizon visibility
- No what-if analysis
- Manual order creation at each level

## Proposed Enhancement (v2.x)

### Concept: Planned Orders

Instead of creating actual WOs and POs directly, the MRP system would generate **Planned Orders** - suggestions that can be reviewed, modified, and then "released" to become actual orders.

```
Sales Orders (Independent Demand)
    ↓
MRP Run (scheduled or on-demand)
    ↓
Planned Orders Generated
    ├── Planned Production Orders (for make items)
    └── Planned Purchase Orders (for buy items)
    ↓
User Review & Firming
    ↓
Release to Actual Orders
```

### Key Features

#### 1. MRP Run Parameters

```python
class MRPRunRequest:
    planning_horizon_days: int = 30  # How far ahead to plan
    include_forecasts: bool = False  # Include demand forecasts
    include_safety_stock: bool = True  # Consider safety stock levels
    regenerate_planned: bool = True  # Delete unfirmed planned orders
    respect_lead_times: bool = True  # Schedule based on lead times
```

#### 2. Demand Sources

- **Sales Orders** - Confirmed customer orders
- **Forecasts** - Predicted future demand (optional)
- **Safety Stock** - Minimum inventory levels
- **Interplant Transfers** - Multi-location demand (future)

#### 3. Planned Order Lifecycle

```
planned → firmed → released
    ↓         ↓
cancelled  cancelled
```

- **Planned**: Auto-generated by MRP, can be deleted/regenerated
- **Firmed**: Locked by user, won't be deleted by next MRP run
- **Released**: Converted to actual WO or PO

#### 4. Demand Pegging

Track where each requirement comes from:

```python
class PlannedOrder:
    source_demand_type: str  # "sales_order", "forecast", "safety_stock"
    source_demand_id: int    # Link to originating demand
    pegging_details: list    # Full trace of demand chain
```

#### 5. Net Requirements Calculation

```
Net Requirement = Gross Requirement
                - On-Hand Inventory
                - Scheduled Receipts (open POs)
                - Planned Receipts (planned orders)
                + Safety Stock
```

#### 6. Order Batching & Consolidation

Multiple demands can be consolidated:

```
SO-001: Needs 10 units of MAT-001 by Jan 15
SO-002: Needs 15 units of MAT-001 by Jan 18
SO-003: Needs 8 units of MAT-001 by Jan 20
    ↓
MRP suggests: 1 PO for 33 units, due Jan 12 (with lead time)
```

### API Endpoints

#### Run MRP
```
POST /api/v1/mrp/run
{
    "planning_horizon_days": 30,
    "include_forecasts": false,
    "regenerate_planned": true
}
```

#### View Planned Orders
```
GET /api/v1/mrp/planned-orders
GET /api/v1/mrp/planned-orders?type=production
GET /api/v1/mrp/planned-orders?type=purchase
GET /api/v1/mrp/planned-orders?product_id=123
```

#### Firm a Planned Order
```
POST /api/v1/mrp/planned-orders/{id}/firm
```

#### Release to Actual Order
```
POST /api/v1/mrp/planned-orders/{id}/release
{
    "vendor_id": 5  // Required for purchase orders
}
```

#### Supply/Demand Timeline
```
GET /api/v1/mrp/supply-demand/{product_id}
```

Returns timeline view:
```json
{
    "product_sku": "MAT-001",
    "current_on_hand": 50,
    "timeline": [
        {"date": "2025-01-10", "type": "demand", "qty": -20, "source": "SO-001", "balance": 30},
        {"date": "2025-01-12", "type": "supply", "qty": 100, "source": "PO-005", "balance": 130},
        {"date": "2025-01-15", "type": "demand", "qty": -45, "source": "WO-003", "balance": 85}
    ],
    "projected_shortage_date": null,
    "days_of_supply": 45
}
```

### UI Components

#### MRP Dashboard
- Run MRP button with parameter dialog
- Summary cards: Planned WOs, Planned POs, Items with Shortages
- Alerts for items with lead time issues

#### Planned Orders List
- Filter by type, status, due date
- Bulk firm/release actions
- Exception highlighting (late, short)

#### Supply/Demand Graph
- Visual timeline per product
- Shows balance over time
- Highlights shortage periods

### Database Schema

```sql
-- Already exists in current system
CREATE TABLE mrp_runs (
    id INT PRIMARY KEY,
    run_date DATETIME,
    planning_horizon_days INT,
    status VARCHAR(20),
    orders_processed INT,
    components_analyzed INT,
    shortages_found INT,
    planned_orders_created INT
);

CREATE TABLE planned_orders (
    id INT PRIMARY KEY,
    mrp_run_id INT,
    order_type VARCHAR(20),  -- 'production' or 'purchase'
    product_id INT,
    quantity DECIMAL,
    due_date DATE,
    start_date DATE,
    status VARCHAR(20),  -- 'planned', 'firmed', 'released', 'cancelled'
    source_demand_type VARCHAR(50),
    source_demand_id INT,
    converted_to_po_id INT,  -- After release
    converted_to_mo_id INT,  -- After release
    firmed_at DATETIME,
    released_at DATETIME
);
```

### Implementation Phases

#### Phase 1: Core MRP Engine (Exists)
- [x] BOM explosion with scrap factors
- [x] Net requirements calculation
- [x] Planned order generation
- [x] Circular reference detection

#### Phase 2: User Workflow
- [ ] MRP Dashboard page
- [ ] Planned orders list with filtering
- [ ] Firm/release workflow
- [ ] Batch operations

#### Phase 3: Advanced Features
- [ ] Demand forecasting integration
- [ ] Multi-level pegging report
- [ ] What-if simulation mode
- [ ] Automatic MRP scheduling (daily/weekly)

#### Phase 4: Optimization
- [ ] Order batching suggestions
- [ ] Lead time optimization
- [ ] Vendor selection for POs
- [ ] Capacity-constrained planning

### Benefits

| Benefit | Description |
|---------|-------------|
| **Visibility** | See all requirements 30/60/90 days ahead |
| **Consolidation** | Batch orders to reduce PO count and get volume discounts |
| **What-If** | Simulate changes before committing |
| **Audit Trail** | Full history of why orders were created |
| **Automation** | Schedule MRP to run automatically |
| **Exception Management** | Focus on items that need attention |

### References

- [Infor Visual MRP](https://www.visualbusiness.net/material-requirements-planning)
- [MRPeasy Multi-Level BOM](https://www.mrpeasy.com/demo-videos/multi-level-bom-and-multi-level-production-scheduling/)
- [SAP MRP Documentation](https://learning.sap.com/courses/detailing-production-accounting-by-order-in-sales-order-related-production)

### Notes

The existing `/api/v1/mrp/*` endpoints provide much of this functionality already. The main work would be:
1. Building the UI components
2. Integrating MRP into the SO workflow
3. Adding the firm/release user experience
4. Creating the supply/demand visualization
